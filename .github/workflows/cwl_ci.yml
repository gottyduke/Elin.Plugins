name: Custom Whatever Loader CI Deploy

on:
  push:
    branches: ["*"]
    paths: ["CustomWhateverLoader/**"]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  build-and-upload:
    name: Build
    runs-on: windows-2025

    strategy:
      matrix:
        version: [stable, nightly]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          sparse-checkout: |
            CustomWhateverLoader/
            Directory.Build.props
          sparse-checkout-cone-mode: false

      - name: Checkout Deps
        uses: actions/checkout@v5
        with:
          path: ${{ matrix.version }}
          ref: ${{ matrix.version }}
          repository: gottyduke/Elin.Plugins.BuildDeps
          ssh-key: ${{ secrets.DEPS_DEPLOY_KEY }}

      - name: Setup DotNet
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x
          dotnet-quality: preview
          cache: true
          cache-dependency-path: ${{ github.workspace }}\CustomWhateverLoader\packages.lock.json

      - name: Setup Packages
        run: dotnet restore ${{ github.workspace }}\CustomWhateverLoader\ --locked-mode

      - name: Build
        id: build
        env:
          ElinGamePath: ${{ github.workspace }}\${{ matrix.version }}
        shell: pwsh
        run: |
          $config = '${{ matrix.version }}' -eq 'stable' ? 'Debug' : 'DebugNightly'
          dotnet build ${{ github.workspace }}\CustomWhateverLoader\CustomWhateverLoader.csproj -o ${{ github.workspace }}\out\${{ matrix.version }} -c $config --no-restore
          
          $dllPath = Join-Path -Path "${{ github.workspace }}\out\${{ matrix.version }}" -ChildPath "CustomWhateverLoader.dll"
          $fileVersion = (Get-Item -Path $dllPath).VersionInfo.FileVersion
          echo "file_version=$fileVersion" >> $env:GITHUB_OUTPUT

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: cwl-ci-builds-${{ steps.build.outputs.file_version }}-${{ matrix.version }}
          path: ${{ github.workspace }}\out\${{ matrix.version }}
